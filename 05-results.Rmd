# Results

## US Whole Stock Market

Start to explore

5-year weekly return :

```{r}
library(tidyverse)
library(viridis)
library(plotly)
library(ggalluvial)
library(scales)
library(parcoords)
Return_df <- pivot_longer(USStock_Return,!Date,
                         names_to = "Sector",
                         values_to = "Return")%>%
  group_by(Sector)

g1 <- ggplot(Return_df,aes(x=Date,y=Return,color=Sector))+
  geom_line()+
  labs(title = "US Stock Market Performance in the past 5 years",
       y="Return(%)")+
  theme_grey(12)+
  theme(legend.title = element_blank())
g1
```


```{r}
g2 <- ggplot(Return_df,aes(Return))+
  geom_histogram(color = "blue", fill = "lightblue")+
  facet_wrap(~Sector,scales = "free_x")
g2
```

```{r}
g3 <- ggplot(Return_df,aes(Return,Sector))+
  geom_boxplot()+
  labs(title="",
       x="Return (%)")+
  theme_grey(12)
g3
```

```{r}
library(ggridges)
g4 <- ggplot(Return_df,aes(x=Return,y=reorder(Sector,-Return,median)))+
  geom_density_ridges(fill="blue",alpha=0.5)+
  labs(title="",
       y="Sector",
       x="Return (%)")
g4
```


```{r}
head(USStock_Price)
tail(USStock_Price)

start_date <- "2017-01-06"
```

Info-tech perform best. 


### SP500 Constitutent

```{r}
library(treemap)
head(SP500_sector)

#Treemap of 2021 Sector Composition
treemap(SP500_sector,index="Sector",vSize="2021",title = "SP500 Constituent in 2021")
```
```{r}


SP500_sector_year <- SP500_sector%>%
  select(c("Sector","1989","1999","2009","2011","2012","2013","2014","2015","2016","2017","2018","2019","2020","2021"))
#%>%
 # mutate(Sector=c("EN","M","I","CD","CS","HC","F","IT","CoS","U","RE"))

#SP500_sector_year[,names(SP500_sector_year)!="Sector"]<- sapply(SP500_sector_year[,names(SP500_sector_year)!="Sector"],function(x) percent(x, accuracy=1))


#gg_SP500_sector_year <- SP500_sector_year%>%
#  to_lodes_form(axes=2:15)

#al_plot <- ggplot(gg_SP500_sector_year,aes(alluvium=Sector,x=x,stratum=stratum))+
#  geom_flow(aes(fill=Sector),width=1/12)+
#  geom_stratum(color="black")+
#  geom_text(stat = "stratum",aes(label=paste(after_stat(stratum))))+
#  scale_y_continuous(expand = c(0.01,0))+
#  theme_classic()
#al_plot
```
We separate the sector into 2 Categories, one is "High-weighted", which proportion is over 10%, another is "Low-weighted"

Plot the interactive plot to see the change of weight in different sector. 

```{r}
SP500_sector_year2 <- SP500_sector_year%>%
  mutate(Category = as.factor(ifelse(SP500_sector_year$`2021`<0.1,"Low-weighted","High-weighted")))
head(SP500_sector_year2)

g11 <- SP500_sector_year2%>%
  arrange(Category)%>%
  parcoords(rownames = F,
            brushMode ="1D-axes",
            reorderable = T,
            queue = T,
            color=list(colorBy = "Category",colorScale="scaleOrdinal",colorScheme="schemeSet1"),
            withD3 =T)
g11
```

Investigate weight in different situations:

```{r,echo=FALSE,fig.width = 10}
library(vcd)

SP500_sector_situation <- SP500_sector%>%
  select(c("Sector","2021","2020","covid_low","election_1","pre-covid_hi"))%>%
  mutate(Sector=c("EN","M","I","CD","CS","HC","F","IT","CoS","U","RE"))
head(SP500_sector_situation)

tidy_situation <- SP500_sector_situation%>%
  gather(key="Group",value="Freq",-Sector)
head(tidy_situation)
tidy_situation$Group <- fct_rev(tidy_situation$Group)

mosaic(Group~Sector, direction=c("h","v"),tidy_situation,
       highlighting_fill = c("grey80","cornflowerblue","lightblue","darkseagreen2","lightpink"))

```

```{r}
g5 <- ggplot(tidy_situation,aes(x=Group,y=Freq,fill=Sector))+
  geom_bar(position = "fill",stat="identity")+
  theme_minimal()+
  scale_fill_manual('position',values = c('coral2', 'steelblue', 'pink',"grey80","cornflowerblue","lightblue","darkseagreen2","lightpink","hotpink","lightsteelblue","plum2"))

g5
```


### Specific Industry Analysis

The price-to-earnings ratio is one of the most widely used metrics for investors and analysts to determine tock valuation. 

In short, the P/E shows what the market is willing to pay today for a stock based on its past or future earnings. 

A higher P/E ratio shows that investors are willing to pay a higher sshare price today because of growth expectations in the future. The average P/E for the S&P 500 has historically ranged from 13 to 15. 

```{r}
PE_analysis <- SP500_comp_df%>%
  select(Name,Sector,Price,Earnings_Share,Price_Earnings)
head(PE_analysis)
```
```{r}
g8 <- ggplot(PE_analysis,aes(x=Earnings_Share,y=Price))+
  geom_point()
g8
```

```{r}
PE_analysis_improved <- PE_analysis%>%
  filter(Earnings_Share>0&Price<400)%>%
  filter(Earnings_Share<20)%>%
  filter(Price_Earnings>0 & Price_Earnings<50)
```


```{r}
g10 <- plot_ly(PE_analysis_improved,x=~Earnings_Share,y=~Price,color=~Sector,text=~Name,
              market = list(size=7))%>%
  layout(title="",
         xaxis = list(title="Earnings_Share"),
         yaxis = list(title="Price"))
g10
```


Focus on IT/Health Care/Consumer Discretionary/Financials
```{r}
head(USStock_Return)

Relative_Return <- USStock_Return%>%
  select(Date,R_SP500,R_Infotech,R_Health,R_ConsumerD,R_Fin)%>%
  mutate(RR_IT = R_Infotech/R_SP500,
         RR_Health = R_Health/R_SP500,
         RR_ConsumerD = R_ConsumerD/R_SP500,
         RR_Fin = R_Fin/R_SP500)%>%
  drop_na()
```




```{r}
example2 <- Relative_Return%>%
  select(Date,R_SP500,R_Infotech,R_Health,R_ConsumerD,R_Fin)%>%
  pivot_longer(cols=c("R_Infotech","R_Health","R_ConsumerD","R_Fin"),names_to = "Type",values_to = "Return")%>%
  mutate(Relative_Return = Return/R_SP500)
#  mutate(Evaluation = as.factor(ifelse(example2$Relative_Return<1,"Not Recommend",
#                                         ifelse(example2$Relative_Return>=1 & #example2$Relative_Return<=2,"Recommend","Highly Recommend"))))

head(example2)
g6 <- ggplot(example2,aes(x=R_SP500,y=Return,color=Type))+
  geom_point()+
  geom_abline(slope=2,intercept = 0,linetype=4)+
  geom_abline(slope=1,intercept = 0,linetype=4)+
  geom_abline(slope=1/2,intercept = 0,linetype=4)+
  theme_minimal()+
  labs(title = "",
       x="Return of SP500 Index",
       y="Return of Sector Index")
g6
```

### IT Industry Specific Analysis

Pick up IT Companies

```{r}
IT_company <- SP500_comp_df%>%
  filter(Sector=="Information Technology")%>%
  arrange(desc(Market_Cap))
#Company correlation
head(SP500_comp_df)
head(IT_company,11)
```

The top4 Companies are Apple/GooGle/MSFT/FB


```{r}
APPLE <- read.csv("C:/Users/weili/Desktop/G5293/Final Project/AAPL.csv")%>%
  select(Date,Close)%>%
  rename(Apple_close=Close)%>%
  mutate(Apple_return = c(-diff(APPLE$Apple_close)/APPLE$Apple_close[-1] *  100, NA))

Google <- read.csv("C:/Users/weili/Desktop/G5293/Final Project/GOOG.csv")%>%
  select(Date,Close)%>%
  rename(Google_close=Close)%>%
  mutate(Google_return = c(-diff(Google$Google_close)/Google$Google_close[-1] *  100, NA))

MSFT <- read.csv("C:/Users/weili/Desktop/G5293/Final Project/MSFT.csv")%>%
  select(Date,Close)%>%
  rename(MSFT_close=Close)%>%
  mutate(MSFT_return = c(-diff(MSFT$MSFT_close)/MSFT$MSFT_close[-1] *  100, NA))

Facebook <- read.csv("C:/Users/weili/Desktop/G5293/Final Project/FB.csv")%>%
  select(Date,Close)%>%
  rename(FB_close=Close)%>%
  mutate(FB_return = c(-diff(Facebook$FB_close)/Facebook$FB_close[-1] *  100, NA)) 
```

```{r}
IT_top4_company <- APPLE%>%
  left_join(Google,by="Date")%>%
  left_join(MSFT,by="Date")%>%
  left_join(Facebook,by="Date")
IT_top4_company_return <- IT_top4_company%>%
  select(Date,ends_with("_return"))%>%
  drop_na() #Drop the last row which has no return 
```


```{r}
panel.hist <- function(x, ...) {
    usr <- par("usr")
    on.exit(par(usr))
    par(usr = c(usr[1:2], 0, 1.5))
    his <- hist(x, plot = FALSE,breaks=20)
    breaks <- his$breaks
    nB <- length(breaks)
    y <- his$counts
    y <- y/max(y)
    rect(breaks[-nB], 0, breaks[-1], y, col = rgb(0, 1, 1, alpha = 0.5), ...)
    # lines(density(x), col = 2, lwd = 2) # Uncomment to add density lines
}
pairs(~Apple_return+Google_return+MSFT_return+FB_return,
      data=IT_top4_company_return,
      labels=c("Apple","Google","Microsoft","Facebook"),
      main="Tech Stocks",
      diag.panel = panel.hist)
```



```{r}
library(reshape)
cor_IT <- round(cor(IT_top4_company_return[,2:5]),2)
head(cor_IT)

melted_cor_IT <- melt(cor_IT)
g12 <- ggplot(data=melted_cor_IT,aes(x=X1,y=X2,fill=value))+
  geom_tile()+
  geom_text(aes(X1,X2,label=value),
            color="white",size=6)

g12
```